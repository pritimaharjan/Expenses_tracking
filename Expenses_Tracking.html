<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Expense Tracking System</title>
    <style>
        .main{
            display: flex;
            justify-content: center;
        }
        .container{
            display: flex;
            flex-direction: column;
            justify-content: center;
           padding: 10px 10px;
           margin: 10px 10px;
            background-color: #008b8b;
            height: auto;
            width: auto;
            color: black;
            box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
            border-radius: 10px;
        }
        .form{
            display: flex;
            flex-direction: row;
            justify-content: space-evenly;
            padding: 10px 10px;
            margin: 5px 5px;
            gap: 20px;
        }
        #description ,#amount
        {
            height: 30px;
            padding: 3px;
            border: 1px;
            border-radius: 5px;
        }
        button{
            height: 35px;
            padding: 3px;
            border: 1px;
            border-radius: 5px;
           
            background-color: none;
        }
.total{
    display: flex;
justify-content: flex-end;
color: antiquewhite;

}
#des{
     display: flex;
    flex-direction: row;
    color: aliceblue;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    
}

.expenses_list{
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    margin: 10px;
     
}
#edit, #delete{
    width: 80px;
}
#search{
    height: 30px;
            padding: 3px;
            border: 1px;
            border-radius: 5px;
}
.piechart{
    display: flex;
    flex-direction: row;

}
canvas {
  width: 350px !important;
  height: 350px !important;
  max-width: 350px;
  max-height: 350px;
  
}
    </style>
</head>
<body>
    <div class="main">
        
        <div class="container">
            <h2 style="text-align: center; color:white">Expense Tracking from</h2>
<form  id="form" class="form">
        <input type="Text" placeholder="Description" id="description">
        <input type="number" placeholder="Amount" id="amount">
        <button type="submit" style="color:#9d9d9d; width:150px;">Add Expenses</button>
        <input type="text" id="search" placeholder="Search expenses...">
    </form>
    <div class ="piechart">

        <ul id="expenses_list"></ul>
  <canvas id="expenseChart" width="350" height="350"></canvas>
    </div>
    
     <div class="total">
        Total : Rs<span id="total">00.0</span>
        </div>
        <div>
            <button onclick="downloadList()">Download list</button>
        </div>
    
    </div>
    </div>
    

    <script>
        const form = document.getElementById("form")
        const descriptionInput = document.getElementById("description")
        const amountInput = document.getElementById("amount")
        const expenseList = document.getElementById("expenses_list")
        const totalDisplay = document.getElementById("total")

        let storage = JSON.parse(localStorage.getItem("storage")) ||[]

       function saveExpense(){
        localStorage.setItem("storage",JSON.stringify(storage))
       } 
     function renderExpense(filteredData) {
  // If no filteredData is provided, use the full storage array
  const dataToRender = filteredData || storage;

  expenseList.innerHTML = "";
  let total = 0;

  dataToRender.forEach((expense, i) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div class="expenses_list">
        <div id="des">
          <span>${expense.description}</span>
          <span>${expense.amount}</span>
          <span>${expense.date}</span>
        </div>
        <div id="button">
          <button onclick="editExpense(${storage.indexOf(expense)})" id="edit">Edit</button>
          <button onclick="deleteExpense(${storage.indexOf(expense)})" id="delete">Delete</button>
        </div>
      </div>
    `;
    expenseList.appendChild(li);
    total += expense.amount;
  });

  totalDisplay.textContent = total.toFixed(2);
  updateChart();
}

       function downloadList(){
        let csv="Categories,Amount,Date\n" 

        storage.forEach(expense=>{csv+=`${expense.description},${expense.amount},${expense.date}\n`;});

        const blob =new Blob([csv],{type:"text/csv"});
        const url=URL.createObjectURL(blob);

        const a=document.createElement("a");
        a.href = url;
        a.download = "expense.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

       }
      

        form.addEventListener("submit",function(e){
            e.preventDefault();
              const description=descriptionInput.value.trim()
              const amount =parseFloat(amountInput.value)
              
              if(!description || isNaN(amount) || amount<=0)
              {
                alert("please, enter valied imformation");
                return;
              }

             const expense ={
               description,
               amount,
               date:new Date().toLocaleDateString()
              }
              storage.push(expense)
                saveExpense();
                renderExpense();
                form.reset();
              

        });
        window.deleteExpense= function(i){
            storage.splice(i,1)
            saveExpense();
            renderExpense();

        }
        window.editExpense = function(i){
            const newdescription =prompt("edit description",storage[i].description)
            const newamount =parseFloat(prompt("edit amount",storage[i].amount))
            if (!newdescription || isNaN(newamount) || newamount<=0 )
            {
                alert("please, enter valid  input")
                return;
            }
            storage[i].description =newdescription
            storage[i].amount = newamount
            saveExpense();
            renderExpense();

        }
        const searchInput = document.getElementById("search");




// Search filter
searchInput.addEventListener("input", function() {
  const searchText = searchInput.value.toLowerCase();
  const filtered = storage.filter(expense => 
    expense.description.toLowerCase().includes(searchText)
  );
  renderExpense(filtered);
});

//chart
let expenseChart;
function updateChart()
{
    const labels = [] ;
    const data = [] ;

    storage.forEach(expense=>
    {
        const index = labels.indexOf(expense.description);
        if (index ===-1){
            labels.push(expense.description)
            data.push(expense.amount)
        }
        else{
            data[index]+=expense.amount;
        }
        
    });
     //if the chart is already exist,destroy before creating new.
     if(expenseChart){
        expenseChart.destroy();
     }

     const chart = document.getElementById("expenseChart").getContext("2d");
     const colors = labels.map((_, i) => `hsl(${i * 40}, 70%, 50%)`);
expenseChart = new Chart( chart,{
    type :"pie",
    data:{
        labels:labels,
        datasets:[{
            data:data,
            backgroundColor:colors,
        }]
        
    },
    options: {
      plugins: {
        legend: {
          labels: {
            color: "white" // This changes label text color
          }
        }
      }
    }
    
})
}
renderExpense();
    </script>
</body>
</html>
